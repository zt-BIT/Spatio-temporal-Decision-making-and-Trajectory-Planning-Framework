# Spatio-temporal-Decision-making-and-Trajectory-Planning-Framework
This code is for the work of《A Unified Framework Integrating Decision Making and Trajectory Planning Based on Spatio-temporal Voxels for Highway Autonomous Driving》(**UNDER REVIEW**), which is a systematic framework designed for autonomous vehicles planning in dynamic highway environments.

## Introduction
This work integrates the Long-Term Behavior Planning (`LTBP`) and Short-Term Dynamic Planning (`STDP`) running in two parallel threads with different horizon, consequently forming a closed-loop maneuver and trajectory planning system that can react to the dynamic environment effectively and efficiently.<br> 

In LTBP, a novel `voxel` structure and the `voxel expansion` algorithm are proposed for the generation of **driving corridors**(the passable space without obstacles) in 3D configuration, which involves the prediction states of surrounding vehicles. By associating the voxels and calculating the weighted edges, the complex traffic scenario can be
abstracted into a brief graph structure, thereby transforming the sophisticated dynamic planning problem into a quantified graph search problem. The maneuver with minimal cost is determined in form of voxel sequences by Dijkstra, then a Quadratic Programming (QP) problem is constructed for solving the optimal trajectory.<br>

In STDP, another small-scaled QP problem is performed in response to dynamic obstacles in short term and track the reference trajectory generated by LTBP. Meanwhile, a Responsibility-Sensitive Safety (RSS) Checker keeps running at high frequency for real-time feedback to ensure security.

## Prerequisites
The experiments are based on ROS (Robot Operating System) with a computer equipped with an Intel I5-3470 CPU and an NVIDIA GeForce GTX 2080-Ti graphics card writen in Python. The tested data-sets are extracted from **NGSIM**（https://www.fhwa.dot.gov/publications/research/operations/07030/index.cfm）

## Main Files

* **main.py**: main funtion. To run: python main.py --train_eval  
* **models**: model OBJECT  
* **utils**: 

  * dataloader.py    
  * util_MDN.py: calculate the pdf given Gaussian params  
  * get_tensor.py: fetch tensor from the graph    
  * visualize.py: visualization
* **example_data**: example testing data  
* **saved_models**: trained LSTM_MDN model

## Prediction Results

* Scenario1   

![](https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/scenario1.png)

* Scenario2   

![](https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/scenario2.png)

* Scenario3

![](https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/scenario3.png)

## Spatio-temporal Navigation Map

* lane keeping  

 * 3D map   
 ![](https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_keep.png)
 
 * top view &  cross-section of t=1.0s &  cross-section of t=2.0s  

 <div align=center><img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/top_view_keep.jpg" width="300"/></div>
  
 <div align=center>
   <img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_keep_t10.png" width="300"/><img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_keep_t20.png" width="300"/>
</div>

* lane changing  

 * 3D map  
 ![](https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_change.jpg)
 
 * top view &   cross-section of t=1.0s &  cross-section of t=2.0s  
 <div align=center><img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/top_view_change.jpg" width="300"/></div>
 
 <div align=center>
 <img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_change_t10.jpg" width="300"/><img src="https://github.com/zt600158/Spatio-temporal-Navigation-Map-based-on-Prediction/blob/master/figs/lane_change_t20.jpg" width="300"/>
</div>

## [Coming soon]Local Path Planning

Based on the constucted 'Spatio-temporal Navigation Map', we further conduct local path planning for the ego vehicle. As the dynamic motion of the surrounding vehicles are tranformed into the static obstacles along the time axis, we employ Hybird A* algorithm to search the rough trajectory in a discrete space. Then the trajectory is represented by a continuous spline which confirms to the dynamic feasibility of the vehicles. Consequently, the spatio-temporal path planning is realized so as to avoid collisions with dynamic obstacles. The relevant work will be updated in this Github...
